### 实验六：CPU 综合设计（详尽整理）

---

## 实验概述
本实验是对**计算机组成与系统结构**课程内容的总结性实验，要求设计并实现一个基于 **MIPS 指令集** 的 CPU。实验内容涵盖单周期、多周期、以及五级流水线 CPU 的实现，目标是通过模块化设计，逐步实现一个完整的 CPU 系统，并掌握不同 CPU 设计方案的优缺点。

实验内容分为基础任务和进阶任务，其中基础任务旨在实现基本功能，而进阶任务涉及更复杂的性能优化和扩展功能。

---

## 实验目标
1. **基础要求**：
   - 设计一个基于 MIPS 指令集的 CPU，支持以下基本指令：
     - 算术运算：`add`, `sub`, `addi`
     - 数据访问：`lw`, `sw`
     - 分支跳转：`beq`, `j`
     - 空操作：`nop`
   - 必须实现以下模块：
     - **寄存器组**
     - **RAM 模块**
     - **ALU 模块**
     - **指令译码模块**
   - CPU 必须能够运行简单的汇编指令。

2. **进阶要求（可选任务）**：
   - 实现 **多周期 CPU**（分数范围 B-~B+）。
   - 实现以下高级功能之一（分数范围 A-~A+）：
     1. 五级流水线 CPU。
     2. 超标量 CPU。
     3. 四路组相联缓存。
   - CPU 可以基于其他指令集（如 RISC-V 或 ARM）设计和实现。
   - 注意：若发现代码抄袭，成绩记为不及格。

---

## 实验内容详解

### 1. **MIPS 指令集与操作码**
实验基于 MIPS 指令集，以下是支持的指令及其功能：

#### 1.1 R-Type 指令
- **`add rd, rs, rt`**：将寄存器 `rs` 和 `rt` 的值相加，结果存储到 `rd`。
  - 操作码：`000000`
  - 功能码：`20`
- **`sub rd, rs, rt`**：将寄存器 `rs` 的值减去 `rt` 的值，结果存储到 `rd`。
  - 操作码：`000000`
  - 功能码：`22`

#### 1.2 I-Type 指令
- **`addi rt, rs, immediate`**：`rs` 的值与立即数相加，结果存储到 `rt`。
  - 操作码：`001000`
- **`lw rt, offset(rs)`**：从地址 `rs + offset` 加载数据到 `rt`。
  - 操作码：`100011`
- **`sw rt, offset(rs)`**：将 `rt` 中的数据存储到地址 `rs + offset`。
  - 操作码：`101011`
- **`beq rs, rt, offset`**：若 `rs == rt`，则跳转到 `PC + 4 + offset`。
  - 操作码：`000100`

#### 1.3 J-Type 指令
- **`j target`**：无条件跳转到目标地址。
  - 操作码：`000010`

#### 1.4 NOP 指令
- **`nop`**：空指令，不执行任何操作。
  - 操作码：`000000`

#### 1.5 ALU 操作码
- `00000`：加法。
- `00001`：减法。
- `00010`：逻辑与。
- `00011`：逻辑或。
- `00100`：逻辑非。

---

### 2. **单周期 CPU**

#### 2.1 设计原理
- 每条指令在一个时钟周期内完成。
- 指令的执行过程包括以下步骤：
  1. **取指（Fetch）**：从指令存储器中取出指令。
  2. **译码（Decode）**：解析指令，生成控制信号。
  3. **执行（Execute）**：ALU 执行运算。
  4. **访存（Memory Access）**：访问数据存储器。
  5. **写回（Write Back）**：将结果写回寄存器。

#### 2.2 模块设计
- **控制单元**：根据指令生成控制信号。
- **寄存器文件**：提供寄存器的读写功能。
- **ALU**：执行算术与逻辑运算。
- **数据存储器**：用于 `lw` 和 `sw` 指令。
- **程序计数器（PC）**：指向当前指令地址。

#### 2.3 实现框架
```verilog
module SimpleMIPSCPU(
    input wire clk,
    input wire rst,
    input wire [31:0] instruction,
    output reg [31:0] result
);
// 寄存器文件
reg [31:0] registers [0:31];
...
endmodule
```

#### 2.4 单周期 CPU 优缺点
- **优点**：设计简单，易于理解。
- **缺点**：每条指令需要占用完整的时钟周期，性能有限。

---

### 3. **多周期 CPU**

#### 3.1 设计原理
- 将指令执行分为多个阶段，每个阶段占用一个时钟周期：
  1. **取指（FETCH）**
  2. **译码（DECODE）**
  3. **执行（EXECUTE）**
  4. **访存（MEMORY ACCESS）**
  5. **写回（WRITE BACK）**

#### 3.2 状态机设计
使用有限状态机（FSM）控制 CPU 工作流程：
```verilog
always @(posedge clk or posedge reset) begin
    case (state)
        FETCH: next_state = DECODE;
        DECODE: next_state = EXECUTE;
        EXECUTE: ...
    endcase
end
```

#### 3.3 多周期 CPU 优缺点
- **优点**：提高硬件利用率。
- **缺点**：控制逻辑复杂，设计难度较高。

---

### 4. **五级流水线 CPU**

#### 4.1 设计原理
通过流水线技术，将指令执行划分为 5 个阶段并同时处理多条指令：
1. **取指（IF）**。
2. **译码（ID）**。
3. **执行（EX）**。
4. **访存（MEM）**。
5. **写回（WB）**。

#### 4.2 冒险处理
1. **数据冒险**：通过前推单元（Forwarding Unit）解决。
2. **控制冒险**：引入分支预测（Branch Prediction）。

#### 4.3 五级流水线优缺点
- **优点**：显著提升指令吞吐量。
- **缺点**：复杂性增加，冒险处理成为难点。

---

### 5. **附录：MIPS 指令及操作码**
#### 算术与逻辑指令
- `add`, `sub`, `and`, `or`, `xor` 等。

#### 数据访问指令
- 加载：`lw`, `lb`, `lh`。
- 存储：`sw`, `sb`, `sh`。

#### 跳转与分支指令
- `j`, `beq`, `bne`, `jal`, `jr`。

#### 特殊指令
- `nop`, `mfhi`, `mflo`。

---

### 总结
通过本实验，学生能够深入理解 CPU 的核心模块及其实现过程，包括：
1. 单周期、多周期和流水线 CPU 的实现原理。
2. 基于 MIPS 指令集的模块设计与集成。
3. 冒险处理和性能优化技术。

本实验为进一步学习高性能 CPU 架构和计算机系统设计奠定基础。